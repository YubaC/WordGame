<!DOCTYPE html>
<html lang="zh_cn">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊñáÂ≠óÊ∏∏Êàè</title>

    <link href="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/js/bootstrap.bundle.min.js"></script>
    <script src="lib/jquery/js/jquery-3.6.3.min.js"></script>
</head>

<body>
    <style>
        body {
            font-family: "Noto Color Emoji", sans-serif;
        }

        #map {
            letter-spacing: 0.2em;
            line-height: 1.4em;
            margin-top: 5px;
        }

        #map p {
            margin: 0;
        }

        #map span {
            vertical-align: bottom;
        }

        #game-Inventory {
            width: calc(100% - 40px);
            height: 50px;
            margin: 20px;
            padding: 0px;
            background-color: #e9e9ed;
            border-radius: 5px;
            list-style: none;
            overflow-x: auto;
            overflow-y: hidden;
        }

        #game-Inventory li {
            aspect-ratio: 1/1;
            height: 50px;
            line-height: 50px;
            text-align: center;
            font-size: larger;

            /* border: 1px solid #8f8f9d; */
        }

        #game-Inventory li.active {
            background-color: #bdbdc2;
        }

        button {
            border-radius: 5px;
            border: 1px solid #8f8f9d;
            background-color: #e9e9ed;
        }

        button:hover {
            background-color: #d0d0d7;
        }

        button:active {
            background-color: #b1b1b9;
        }

        button.contron-btn {
            aspect-ratio: 1;
            width: 50px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            cursor: pointer;
        }

        button.direction-btn {
            /* display: inline-block; */
            /* padding: 0; */
            /* margin: 0; */

            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 512'%3E%3C!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --%3E%3Cpath d='M88 166.059V468c0 6.627 5.373 12 12 12h56c6.627 0 12-5.373 12-12V166.059h46.059c21.382 0 32.09-25.851 16.971-40.971l-86.059-86.059c-9.373-9.373-24.569-9.373-33.941 0l-86.059 86.059c-15.119 15.119-4.411 40.971 16.971 40.971H88z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-size: 30%;
            /* color: #fff; */
            /* transition: background-color 0.2s ease-in-out; */
        }

        #downBtn {
            transform: rotate(180deg);
        }

        #leftBtn {
            transform: rotate(-90deg);
        }

        #rightBtn {
            transform: rotate(90deg);
        }

        #direction-buttons {
            max-width: fit-content;
            max-height: fit-content;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 5px;
            justify-items: center;
            align-items: center;
        }

        #upBtn {
            grid-column: 2 / 3;
            grid-row: 1 / 2;
        }

        #downBtn {
            grid-column: 2 / 3;
            grid-row: 3 / 4;
        }

        #leftBtn {
            grid-column: 1 / 2;
            grid-row: 2 / 3;
        }

        #rightBtn {
            grid-column: 3 / 4;
            grid-row: 2 / 3;
        }

        .control-btns-master {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .control-btns {
            margin: 20px;
        }

        #game-stopped-modal .modal-body,
        #gameover-modal .modal-body {
            padding: 100px 50px;
        }

        #gameover-modal {
            transition: opacity 1s linear;
        }

        #game-stopped-modal button,
        #gameover-modal button {
            margin-top: 50px;
        }

        #game-healthbar {
            width: 100%;
            text-align: center;
        }

        /* ÁßªÂä®Á´Ø */
        @media screen and (max-width: 768px) {
            button.contron-btn {
                width: 70px;
            }

            .control-btns-master {
                display: inline-flex;
                flex-direction: row-reverse;
                width: 100%;
                margin-top: 10px;
            }

            .control-btns {
                margin: auto;
            }
        }
    </style>

    <!-- Ê∏∏ÊàèÊöÇÂÅúÁöÑÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="game-stopped-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- Ê®°ÊÄÅÊ°ÜÂÜÖÂÆπ -->
                <div class="modal-body text-center">
                    <h1>Ê∏∏ÊàèÂ∑≤ÊöÇÂÅú</h1>
                    <div class="d-grid">
                        <button type="button" class="btn btn-primary btn-block" data-bs-dismiss="modal">ÁªßÁª≠Ê∏∏Êàè</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ê∏∏ÊàèÁªìÊùüÁöÑÊ®°ÊÄÅÊ°Ü -->
    <div class="modal fade" id="gameover-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- Ê®°ÊÄÅÊ°ÜÂÜÖÂÆπ -->
                <div class="modal-body text-center">
                    <h1>Ê∏∏ÊàèÁªìÊùüÔºÅ</h1>
                    <p id="gaveover-reason"></p>
                    <p id="game-score"></p>
                    <div class="d-grid">
                        <button type="button" class="btn btn-primary btn-block"
                            onclick="location.reload();">ÈáçÊñ∞ÂºÄÂßã</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="game-healthbar"></div>

    <!-- ÁîªÂ∏É -->
    <div id="map" class="text-center"></div>

    <ul id="game-Inventory" class="d-inline-flex"></ul>

    <!-- Êìç‰Ωú -->
    <div class="control-btns-master">
        <div id="direction-buttons" class="control-btns">
            <button id="upBtn" class="contron-btn direction-btn"></button>
            <button id="downBtn" class="contron-btn direction-btn"></button>
            <button id="leftBtn" class="contron-btn direction-btn"></button>
            <button id="rightBtn" class="contron-btn direction-btn"></button>
        </div>

        <div class="control-btns">
            <button id="doBtn" class="contron-btn">&#128163;</button><br>
        </div>

    </div>
    <!--  
----------------‚Üíy
|
|
|
|
|
|
‚Üìx -->
    <!-- <script src="js/tick.js"></script>
    <script src="js/map.js"></script>
    <script src="js/boom.js"></script>
    <script src="js/DrawMap.js"></script>
    <script src="js/mob.js"></script>
    <script src="js/ecosystem.js"></script>
    <script src="js/player.js"></script> -->

    <script type="module">
        import { Ticker } from "./js/tick.js";
        import { EntityLive } from "./js/entity.js";
        import { Map } from "./js/map.js";
        import { Boom } from "./js/boom.js";
        import { MapDrawer } from "./js/DrawMap.js";
        import { SummonMob } from "./js/mob.js";
        import { Eco } from "./js/ecosystem.js";
        import { Player, PlayerController } from "./js/player.js";
        // !Ê≥®ÊÑèÔºÅËøôÈáåÂøÖÈ°ªÈó≠ÂåÖÔºåÂõ†‰∏∫MapÁ±ªÂíåBootStrap5‰∏≠ÁöÑMapÁ±ªÊúâÂÜ≤Á™ÅÔºÅ
        //ÂÆö‰πâÂú∞Âõæ
        let blocks = [
            ["Ëçâ", "Ëçâ", "Ê∞¥", "Ê∞¥", "Ê∞¥", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ"],
            ["Ëçâ", "Ëçâ", "Ê∞¥", "Ê∞¥", "Ê∞¥", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ"],
            ["Ëçâ", "Ëçâ", "Ê∞¥", "Ê∞¥", "Ê∞¥", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ"],
            ["Ëçâ", "Ëçâ", "Ê∞¥", "Ê∞¥", "Ê∞¥", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ"],
            ["Ëçâ", "Ëçâ", "Ê∞¥", "Ê∞¥", "Ê∞¥", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ"],
            ["Ëçâ", "Ëçâ", "Ê∞¥", "Ê∞¥", "Ê∞¥", "Ê∞¥", "Ê∞¥", "Ê∞¥", "Ê°•", "Ê°•", "Ê∞¥", "Ê∞¥"],
            ["Ëçâ", "Ëçâ", "Ê∞¥", "Ê∞¥", "Ê∞¥", "Ê∞¥", "Ê∞¥", "Ê∞¥", "Ê°•", "Ê°•", "Ê∞¥", "Ê∞¥"],
            ["Ëçâ", "Ëçâ", "Ê∞¥", "Ê∞¥", "Ê∞¥", "Ê∞¥", "Ê∞¥", "Ê∞¥", "Ê°•", "Ê°•", "Ê∞¥", "Ê∞¥"],
            ["Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ"],
            ["Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ"],
            ["Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ"],
            ["Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ", "Ëçâ"]
        ];

        // Â∞ÜÊØè‰∏Ä‰∏™block Âèò‰∏∫ {name: "xxx"}
        blocks = blocks.map((row, y) => {
            return row.map((block, x) => {
                return {
                    name: block,
                    x: x,
                    y: y,
                }
            })
        })

        const colorDict = {
            "Ëçâ": "green",
            "Ê∞¥": "blue",
            "Ê°•": "orange",
            "‰∫∫": "red",
            "ÊÄ™": "red",
            "Âúü": "Sienna",
            "ÁÇ∏": "black"
        };

        const inventory = [
            {
                name: "üí£",
                do: function () {
                    // ÈÅçÂéÜÂÆû‰ΩìÔºåÂ¶ÇÊûúËøô‰∏™Ê†ºÂ≠ê‰∏äÊ≤°ÊúâÁÇ∏ÂºπÔºåÂ∞±ÊîæÁΩÆ‰∏ÄÈ¢óÁÇ∏Âºπ
                    if (this.map.entities.some(entity => entity.x === this.x && entity.y === this.y && entity.type === "boom")) {
                        return;
                    }

                    const boom = new Boom({
                        x: this.x,
                        y: this.y,
                        power: 2,
                        map: this.map,
                    });
                    boom.setup();
                    this.ticker.taskList.push(boom);
                    this.map.drawMap();
                }
            },
            {
                name: "Ëçâ",
                do: function () {
                    this.map.blocks[this.x][this.y].name = "Ëçâ";
                    this.map.drawMap();
                }
            },
            {
                name: "Ê°•",
                do: function () {
                    this.map.blocks[this.x][this.y].name = "Ê°•";
                    this.map.drawMap();
                }
            },
            {
                name: "Âúü",
                do: function () {
                    this.map.blocks[this.x][this.y].name = "Âúü";
                    this.map.drawMap();
                }
            }, {
                name: "Ê∞¥",
                do: function () {
                    this.map.blocks[this.x][this.y].name = "Ê∞¥";
                    this.map.drawMap();
                }
            }
        ]

        const passable = ["Ëçâ", "Ê°•", "Âúü", "ÊÄ™", "‰∫∫"];

        var entities = [];

        const mapDrawer = new MapDrawer({
            map: "#map",
            colorDict: colorDict,
        })


        function gameOver() {
            ticker.stop();
            // ÂèñÊ∂àÊöÇÂÅúÊ∏∏Êàè‰∫ã‰ª∂
            window.onblur = null;
            ticker.stop();
            // ÂÜôÂÖ•Ê∏∏ÊàèÁªìÊùüÁöÑÂéüÂõ†
            switch (player.hurtedBy.type) {
                case "boom":
                    $('#gaveover-reason').html(`‰Ω† ÁàÜÁÇ∏‰∫ÜÔºÅ`);
                    break;
                case "mob":
                    $('#gaveover-reason').html(`Ë¢´ÊÄ™Áâ©ÊÆ¥ÊâìËá¥Ê≠ª <del>Ê¨ßÊãâÊ¨ßÊãâÊ¨ßÊãâ</del>`);
                    break;
            }
            // Â±èÂπïÊ∏êÂèòÊàêÈªëÁôΩÔºåÂä®ÁîªÊó∂Èó¥‰∏∫1s
            $('#gameover-modal').modal('show');
        }

        var map = new Map({
            blocks: blocks,
            entities: entities,
            passable: passable,
            drawMapFunc: mapDrawer.drawMap,
            gameOverFunc: gameOver,
        })

        var ticker = new Ticker({
            updateMapFunc: map.drawMap,
        })
        ticker.start();
        window.ticker = ticker;

        new EntityLive({
            map: map,
            ticker: ticker,
        }).setup();

        new SummonMob({
            map: map,
            ticker: ticker,
        }).setup();

        new Eco({
            map: map,
            ticker: ticker,
        }).setup();

        var player = new Player({
            x: 0,
            y: 0,
            map: map,
            ticker: ticker,
            speed: 5,
        });
        player.setup();
        window.player = player;

        var playerController = new PlayerController({
            player: player,
            map: map,
        });
        player.health = 20;

        // ÁîªÂú∞Âõæ
        mapDrawer.drawMap(map);

        // Âêë#game-inventory‰∏≠Ê∑ªÂä†Áâ©ÂìÅ
        inventory.forEach((item) => {
            const li = document.createElement("li");
            li.innerText = item.name;
            // ÊåâÁÖßmap.colorDict‰∏≠ÁöÑÈ¢úËâ≤ÔºåÁªôÊØè‰∏™ÊñπÂùó‰∏äËâ≤
            li.style.color = colorDict[item.name];


            li.onclick = function () {
                const active = document.querySelector("#game-Inventory li.active");
                if (active) {
                    active.classList.remove("active");
                }
                this.classList.add("active");
                player.inventory = item;

                // ÊõøÊç¢playerÁöÑdoÊñπÊ≥ï
                player.do = function () {
                    this.inventory.do.call(this);
                }
                // ËÆæÁΩÆdoBtnÁöÑÊñáÂ≠ó
                document.querySelector("#doBtn").innerText = item.name;
            }
            document.querySelector("#game-Inventory").appendChild(li);
        });

        // ÁÇπÂáªÁ¨¨‰∏Ä‰∏™Áâ©ÂìÅ
        document.querySelector("#game-Inventory li").click();

        let game = {
            stopped: false,
        }
        // Âú®ÂΩìÂâçÊ†áÁ≠æÈ°µÂ§±ÁÑ¶Êó∂ÔºåÊöÇÂÅúÊ∏∏Êàè
        // window.onblur = function () {
        //     ticker.stop();
        //     game.stopped = true;
        //     // Âî§Ëµ∑Ê®°ÊÄÅÊ°Ü
        //     $('#game-stopped-modal').modal('show');
        //     $('#game-stopped-modal').on('hidden.bs.modal', function (e) {
        //         if (game.stopped) {
        //             ticker.start();
        //             game.stopped = false;
        //         }
        //     })
        // }
    </script>

</body>

</html>